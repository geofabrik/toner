machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "shp/osmdata/"
    - "shp/natural_earth/"
  override:
    - if [ "$(git tag -l --contains HEAD)" != "" ]; then make db/shapefiles; fi

test:
  override:
    - if [ "$(git tag -l --contains HEAD)" != "" ]; then docker build -t quay.io/stamen/toner-data:$(git tag -l --contains HEAD) shp/; fi

deployment:
  publish:
    branch: master
    commands:
      - if [ "$(git tag -l --contains HEAD)" != "" ]; then docker login -e ${DOCKER_EMAIL:null} -u  -u "${DOCKER_USER}" -p "${DOCKER_PASS}" ${DOCKER_REGISTRY}; docker push quay.io/stamen/toner-data:$(git tag -l --contains HEAD) shp/; fi
